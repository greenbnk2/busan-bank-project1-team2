<script type="module">
      import Chatbot from "https://cdn.jsdelivr.net/npm/flowise-embed/dist/web.js"

      Chatbot.init({
        chatflowid: "c5c35ce4-18cb-4928-b072-f805252e5889",
        apiHost: "https://cloud.flowiseai.com",


        // RAG/ëª¨ë¸ íŒŒë¼ë¯¸í„° â†“ (í•„ìš” ì—†ìœ¼ë©´ ë¹„ì›Œë‘¬ë„ ë©ë‹ˆë‹¤)
        chatflowConfig: {
            returnSourceDocuments: false,   // "question:..." ì¹© ì œê±°
        },

        // ğŸ”µ UI/ë¬¸êµ¬ ì»¤ìŠ¤í„°ë§ˆì´ì¦ˆ
        theme: {
          button: { backgroundColor: "#D81921", color: "#fff" },
          chatWindow: {
            title: "BNK ì±—ë´‡",
            welcomeMessage: "ì•ˆë…•í•˜ì„¸ìš”! BNK FAQ ì±—ë´‡ì…ë‹ˆë‹¤. ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?",
            inputPlaceholder: "ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”...",
            backgroundColor: "#ffffff",
            fontSize: "15px",
            // ìƒ˜í”Œ ì§ˆë¬¸
            starterPrompts: [
                "ê³„ì¢Œ ê°œì„¤ì€ ì–´ë–»ê²Œ í•˜ë‚˜ìš”?",
                "ì²´í¬ì¹´ë“œ ì¬ë°œê¸‰ ë°©ë²• ì•Œë ¤ì¤˜ìš”",
                "ì˜ˆê¸ˆ ê¸ˆë¦¬ëŠ” ì–´ë””ì„œ í™•ì¸í•  ìˆ˜ ìˆë‚˜ìš”?",
                "ë¹„ëŒ€ë©´ ê³„ì¢Œ ê°œì„¤ ì‹œ í•„ìš”í•œ ê²ƒì€ ë¬´ì—‡ì¸ê°€ìš”?"
            ],
            starterPromptFontSize: 15, // ì¹© ê¸€ì í¬ê¸°
            botMessage: { backgroundColor: "#f3f6ff" },
            userMessage: { backgroundColor: "#0064FF", textColor: "#ffffff" },
            // ğŸ”´ íƒ€ì´í‹€ ë°” ìƒ‰ìƒ ë³€ê²½
            header: { backgroundColor: "#D81921", textColor: "#ffffff" },
            // ğŸ”´ ì…ë ¥ì°½ í™”ì‚´í‘œ ìƒ‰ìƒ ë³€ê²½
            sendButtonColor: "#D81921"
          }
        }
      })

      const getWidget = () =>
          document.querySelector('flowise-chatbot, flowise-embed')

      const createFloatingCloseButton = () => {
          // ì´ë¯¸ ë§Œë“¤ì—ˆìœ¼ë©´ ë‹¤ì‹œ ë§Œë“¤ì§€ ì•ŠìŒ
          if (document.getElementById('bnk-chat-floating-close')) return

          const btn = document.createElement('button')
          btn.id = 'bnk-chat-floating-close'
          btn.innerText = 'Ã—'

          const DURATION = 250   // ì‚¬ë¼ì§ˆ ë•Œë§Œ ì‚¬ìš©

          Object.assign(btn.style, {
              position: 'fixed',
              bottom: '70px',      // í•„ìš”í•˜ë©´ ìœ„ì¹˜ ì¡°ì •
              right: '10px',
              width: '20px',
              height: '20px',
              borderRadius: '50%',
              border: 'none',
              background: '#858689',
              color: '#ffffff',
              fontSize: '18px',
              cursor: 'pointer',
              zIndex: 999999,
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              boxShadow: '0 2px 6px rgba(0,0,0,0.25)'
              // ë“±ì¥ ì• ë‹ˆë©”ì´ì…˜ ì œê±° â†’ ë°”ë¡œ ë³´ì´ë„ë¡
          })

          document.body.appendChild(btn)

          btn.addEventListener('click', () => {
              const w = getWidget()
              if (w) {
                  // ì±—ë´‡ë„ ì„œì„œíˆ ì‚¬ë¼ì§€ê²Œ
                  w.style.transition = `opacity ${DURATION}ms ease`
                  w.style.opacity = '0'
                  setTimeout(() => {
                      w.style.display = 'none'
                  }, DURATION)
              }

              // X ë²„íŠ¼ë„ ì„œì„œíˆ ì‚¬ë¼ì§
              btn.style.transition = `opacity ${DURATION}ms ease`
              btn.style.opacity = '0'
              setTimeout(() => {
                  btn.style.display = 'none'
              }, DURATION)
          })
      }

      // ğŸ”´ X ë²„íŠ¼ ìƒì„± í•¨ìˆ˜
      const ensureCloseButton = () => {
          const host = getWidget()
          const root = host && host.shadowRoot
          if (!root) return

          // ì´ë¯¸ ìˆìœ¼ë©´ ë‹¤ì‹œ ë§Œë“¤ì§€ ì•ŠìŒ
          if (root.querySelector('.bnk-close-btn')) return

          // í—¤ë”(íƒ€ì´í‹€ ë°”) ìš”ì†Œ ì°¾ê¸°
          // part ì†ì„±ì´ "header", "header something" ë“±ì¼ ìˆ˜ ìˆìœ¼ë¯€ë¡œ í† í°/ë¶€ë¶„ ë§¤ì¹­ ì‚¬ìš©
          const header =
              root.querySelector('[part~="header"]') ||  // part ëª©ë¡ì— header í¬í•¨
              root.querySelector('[part*="header"]') ||  // ë¬¸ìì—´ì— header í¬í•¨
              root.querySelector('header')               // ë§ˆì§€ë§‰ fallback

          if (!header) return

          const btn = document.createElement('button')
          btn.textContent = 'Ã—'
          btn.className = 'bnk-close-btn'
          Object.assign(btn.style, {
              border: 'none',
              background: 'transparent',
              color: '#ffffff',
              fontSize: '20px',
              fontWeight: 'bold',
              cursor: 'pointer',
              marginLeft: 'auto',
              padding: '0 10px',
              lineHeight: '1',
              display: 'flex',
              alignItems: 'center'
          })

          // X ëˆ„ë¥´ë©´ ì±—ë´‡ ìˆ¨ê¸°ê¸°
          btn.addEventListener('click', () => {
              const w = getWidget()
              if (w) {
                  w.style.display = 'none'   // í˜ì´ì§€ì—ì„œ ì±—ë´‡ ìˆ¨ê¹€
              }
          })

          // í—¤ë”ì— ë²„íŠ¼ ë¶™ì´ê¸°
          header.style.display = 'flex'
          header.style.alignItems = 'center'
          header.appendChild(btn)
      }

      // ë¸Œëœë“œ ì œê±°
      const nukeBrandingKeepGap = () => {
          const host = getWidget()
          const root = host && host.shadowRoot
          if (!root) return

          let brandNode = root.querySelector('a[href*="flowise"]')

          if (!brandNode) {
              const walker = document.createTreeWalker(root, NodeFilter.SHOW_TEXT)
              let t
              while ((t = walker.nextNode())) {
                  const s = t.textContent.trim().toLowerCase()
                  if (s.includes('powered by')) {
                      brandNode = t.parentElement
                      break
                  }
              }
          }
          if (!brandNode) return

          let row = brandNode
          const isSmall = el => {
              const r = el.getBoundingClientRect()
              return r.height > 10 && r.height < 60 && r.width > 150
          }
          while (row && row !== root && !isSmall(row)) row = row.parentElement
          if (!row) row = brandNode.parentElement

          const h = (row.getBoundingClientRect().height || 28)
          const spacer = document.createElement('div')
          spacer.setAttribute('aria-hidden', 'true')
          spacer.style.height = h + 'px'
          spacer.style.opacity = '0'
          spacer.style.pointerEvents = 'none'
          row.replaceWith(spacer)
      }

      const start = () => {
          const host = getWidget()
          if (!host || !host.shadowRoot) return false

          nukeBrandingKeepGap()
          ensureCloseButton()   // â† ì—¬ê¸°ì„œ X ë²„íŠ¼ í•œ ë²ˆ ìƒì„±

          const obs = new MutationObserver(() => {
              nukeBrandingKeepGap()
              ensureCloseButton() // â† DOM ë³€ê²½ë  ë•Œë§ˆë‹¤ X ë²„íŠ¼ì´ ìœ ì§€ë˜ë„ë¡
          })
          obs.observe(host.shadowRoot, {
              childList: true,
              characterData: true,
              attributes: true,
              subtree: true
          })
          return true
      }

      const boot = setInterval(() => {
          const host = getWidget()
          if (host) {
              // ì±—ë´‡ ì•„ì´ì½˜ì´ DOMì— ìƒê¸´ ì§í›„ X ë²„íŠ¼ ìƒì„±
              createFloatingCloseButton()
          }

          if (start()) {
              clearInterval(boot)
          }
      }, 50)   // 50ms ê°„ê²©ìœ¼ë¡œ ì²´í¬ â†’ ì±—ë´‡ê³¼ ê±°ì˜ ë™ì‹œì— ëœ¸

      // flowise-chatbot / flowise-embed ìš”ì†Œê°€ DOMì— ìƒê¸°ëŠ” ìˆœê°„ ê°ì§€í•´ì„œ
      // ì±—ë´‡ ì´ˆê¸°í™”(start)ì™€ X ë²„íŠ¼ ìƒì„±ì„ ë™ì‹œì— ì‹¤í–‰
      const waitForWidget = new MutationObserver((mutations, observer) => {
          const host = getWidget()
          if (host && host.shadowRoot) {
              createFloatingCloseButton() // X ë²„íŠ¼
              start()                    // branding ì œê±° + í—¤ë” X ë“±
              observer.disconnect()      // í•œ ë²ˆë§Œ ì‹¤í–‰
          }
      })

      // í˜ì´ì§€ ì–´ë””ì— flowise ìœ„ì ¯ì´ ì¶”ê°€ë˜ë“  ê°ì§€
      waitForWidget.observe(document.body, {
          childList: true,
          subtree: true
      })


      // ì¹© ì œê±° ìœ ì§€
      const hideChips = () => {
          const host = getWidget()
          const root = host && host.shadowRoot
          if (!root) return
          root.querySelectorAll('.chatbot-button.selectable').forEach(n => n.remove())
      }
      setInterval(hideChips, 300)
    </script>
    <style>
        /* Flowise ì¹©/ì¶”ì²œ ë²„íŠ¼ë“¤ ì „ë¶€ ìˆ¨ê¹€ */
        .flowise-message-chips,
        .flowise-starter-prompts,
        .message-chips,
        .starter-prompts,
        .chips, .chip, .flowise-chip,
        div[class*="starterPrompt"],
        div[class*="message-suggestion"],
        div[class*="chip"] {
            display: none !important;
        }
    </style>

    <style>
      /* íƒ€ì´í‹€ ë°” */
      flowise-chatbot::part(header),
      flowise-embed::part(header) {
        background: #D81921 !important;
        color: #fff !important;
      }

      /* ì „ì†¡ ë²„íŠ¼(í™”ì‚´í‘œ) */
      flowise-chatbot::part(send-button),
      flowise-embed::part(send-button) {
        color: #D81921 !important;
        fill: #D81921 !important;
      }
    </style>
    

    <style th:inline="css">
      /* ğŸ”´ Flowise ì±—ë´‡ ë²„íŠ¼ì„ ì»¤ìŠ¤í…€ ì´ë¯¸ì§€ë¡œ êµì²´ */
      flowise-chatbot::part(button) {
        background-image: url([[@{/images/chatbot.png}]]); /* ì—…ë¡œë“œí•œ ê²½ë¡œë¡œ ìˆ˜ì • */
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        background-color: transparent !important;
        border: none !important;
      }

      /* ì›í˜• ìœ ì§€ ë° ê·¸ë¦¼ì ì‚´ì§ */
      flowise-chatbot::part(button):hover {
        transform: scale(1.05);
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      }
      /* ğŸ”§ Flowise ì±—ë´‡ ë²„íŠ¼ ì•„ë˜ ìƒê¸°ëŠ” í°ìƒ‰ ê¼¬ë¦¬(âˆ¨, < ëª¨ì–‘) ì œê±° */
      flowise-chatbot::part(host-bubble)::before,
      flowise-chatbot::part(host-bubble)::after,
      flowise-embed::part(host-bubble)::before,
      flowise-embed::part(host-bubble)::after {
        display: none !important;
        content: none !important;
      }

      /* í˜¹ì‹œ í™”ì‚´í‘œë¥¼ ë§Œë“œëŠ” ë‚´ë¶€ divê°€ ìˆì„ ê²½ìš° ëŒ€ë¹„ */
      flowise-chatbot::part(host-bubble),
      flowise-embed::part(host-bubble) {
        overflow: visible;
      }
    </style>
