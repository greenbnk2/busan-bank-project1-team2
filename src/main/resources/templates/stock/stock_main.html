<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>stock_main</title>
    <style>
        main {
            background-color: #F6F6F8;
            padding: 10px 20px 80px;
        }
        body {
            background-color: #F6F6F8;
        }
    </style>
    <style>
        /* íƒ­ ê³µí†µ ìŠ¤íƒ€ì¼ */
        .tab-list {
            list-style: none;
            display: flex;
            padding: 0;
            margin: 0;
        }
        .tab-list li {
            margin-right: 20px;
        }
        .tab-link {
            text-decoration: none;
            color: #444;
            padding-bottom: 6px; /* ë°‘ì¤„ê³¼ ê°„ê²© ë§ì¶”ê¸° */
            display: inline-block;
        }
        /* ì„ íƒëœ íƒ­ ìŠ¤íƒ€ì¼ (ìŠ¤í¬ë¦°ìƒ·ì²˜ëŸ¼ ë°‘ì¤„) */
        .tab-link.active {
            color: #000;
            font-weight: 500;
        }
        .tabs-wrapper {
            position: relative;
            border-bottom: 1px solid grey;
        }
        .tab-underline {
            position: absolute;
            bottom: 0;
            height: 2px;
            background-color: #000;
            left: 0;
            width: 0;
            transition: left 0.2s ease, width 0.2s ease;
        }

        .stock-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            align-items: center;
            padding: 10px 0;
            border-radius: 12px;
            transition: background-color 0.2s ease;  /* ì„œì„œíˆ ë³€í•˜ë„ë¡ */
        }
        .stock-row:hover {
            background-color: #ECEFF3;  /* ì›í•˜ëŠ” íšŒìƒ‰ìœ¼ë¡œ ì¡°ì ˆ */
        }

        /* ë“±ë½ë¥  ë³€í™” ê°•ì¡°ìš© (ë°°ê²½ë§Œ ì‚´ì§ ê¹œë¹¡) */
        @keyframes rateUpBgFlash {
            from { background-color: #FFEAEA; }   /* ìƒìŠ¹ = ì—°í•œ ë¹¨ê°• */
            to   { background-color: transparent; }
        }
        @keyframes rateDownBgFlash {
            from { background-color: #DBE4F5; }   /* í•˜ë½ = ì—°í•œ íŒŒë‘ */
            to   { background-color: transparent; }
        }

        .rate-span {
            padding-top:6px;
            padding-bottom:6px;
            padding-left: 50px;
            border-radius: 8px;
            display: inline-block;
        }

        .rate-change-up {
            animation: rateUpBgFlash 1s ease-out;
        }

        .rate-change-down {
            animation: rateDownBgFlash 1s ease-out;
        }

        .stock-row.flash-up {
            animation: rowUpFlash 0.5s ease-out;
        }
        .stock-row.flash-down {
            animation: rowDownFlash 0.5s ease-out;
        }
            /* í‘œ ì œëª© ì˜ì—­ */
        .stock-header {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            margin-top: 20px;
        }
        .circle-badge {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            color: white;
            font-size: 13px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 17px;
            flex-shrink: 0;
        }
    </style>
    <style>
        .rate-up {
            color: #d60000;   /* ë¹¨ê°„ìƒ‰ */
        }
        .rate-down {
            color: #0051c7;   /* íŒŒë€ìƒ‰ */
        }
        .rate-zero {
            color: #555555;   /* ë³´í•© */
        }
    </style>
    <style>
        .stock-table a {
            text-decoration: none;
            color: black;
        }
    </style>
    <style>
        /* í˜„ì¬ê°€ ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
        .price-span {
            color: #000000;
        }

        /* ì˜¬ë¼ê°ˆ ë•Œ */
        @keyframes priceUpFlash {
            from { color: #de0000; }
            to   { color: #000000; }
        }
        .price-flash-up {
            animation: priceUpFlash 0.6s ease-out;
        }

        /* ë‚´ë ¤ê°ˆ ë•Œ */
        @keyframes priceDownFlash {
            from { color: #0051C7; }
            to   { color: #000000; }
        }
        .price-flash-down {
            animation: priceDownFlash 0.6s ease-out;
        }
    </style>
    <style>
        .toast {
            position: fixed;
            top: 16px;
            left: 50%;
            transform: translateX(-50%) translateY(-10px);
            background: #181e27;
            color: #ffffff;
            border-radius: 12px;
            padding: 8px 18px;
            font-size: 14px;
            display: flex;
            align-items: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease, transform 0.2s ease;
            z-index: 10000;
            box-shadow: 0 6px 20px rgba(0,0,0,0.4);
        }
        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
        .toast-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: #22c55e;
            margin-right: 8px;
        }
    </style>
    <style>
        .ticker-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 40px;
            background: #fff;
            border-bottom: 1px solid #ddd;
            overflow: hidden;
            z-index: 9999;

            display: flex;
            align-items: center;   /* ì„¸ë¡œ ê°€ìš´ë° ì •ë ¬ */
        }

        .ticker-content {
            display: inline-block;
            white-space: nowrap;
            animation: tickerMove 400s linear infinite;
        }

        @keyframes tickerMove {
            0% { transform: translateX(0); }
            100% { transform: translateX(-100%); }
        }
    </style>
    <style>
        .ticker-rate-up {
            color: #d60000; /* ë¹¨ê°• */
        }

        .ticker-rate-down {
            color: #0051c7; /* íŒŒë‘ */
        }

        .ticker-rate-zero {
            color: #555;    /* ë³´í•© */
        }
    </style>
</head>
<body>
    <header>
        <div th:replace="~{layouts/header.html}"></div>
    </header>

    <main>
        <div style="">
            <ul class="tab-list" id="marketTabs" style="list-style: none; display: flex;">
                <li style=" margin-right: 20px;">
                    <a href="#" class="tab-link active" style="text-decoration: none;color: black;">êµ­ë‚´ ì •ê·œì¥</a>
                </li>
                <li>
                    <a href="#" class="tab-link" style=" text-decoration: none; color: black;">í•´ì™¸ ë°ì´ë§ˆì¼“</a>
                </li>
            </ul>
        </div>
        <div class="tabs-wrapper" style="margin-top: 50px; border-bottom: 1px solid grey;">
            <ul class="tab-list" id="subTabs" style="list-style: none; display: flex;">
                <li style=" margin-right: 20px;">
                    <a href="#" class="tab-link active" style="text-decoration: none;color: black;">ì‹¤ì‹œê°„ ì°¨íŠ¸</a>
                </li>
                <li style="margin-right: 20px;">
                    <a href="#" class="tab-link" style=" text-decoration: none; color: black;">ì§€ê¸ˆ ëœ¨ëŠ” ì¹´í…Œê³ ë¦¬</a>
                </li>
                <li>
                    <a href="#" class="tab-link" style=" text-decoration: none; color: black;">êµ­ë‚´ íˆ¬ìì ë™í–¥</a>
                </li>
            </ul>
            <!-- ê²€ì€ìƒ‰ ì›€ì§ì´ëŠ” ë°‘ì¤„ -->
            <div class="tab-underline" id="subTabsUnderline"></div>
        </div>
        <div class="stock-table">
<!--            ì»¬ëŸ¼-->
            <div class="stock-header" style="margin-bottom: 10px;">
                <div id="timeDisplay" style="font-size: 15px; padding-left: 10px;">ìˆœìœ„Â·ì˜¤ëŠ˜ --:-- ê¸°ì¤€</div>
                <div style="font-size: 15px; text-align: end;">í˜„ì¬ê°€</div>
                <div style="font-size: 15px; text-align: end;">ë“±ë½ë¥ </div>
                <div style="font-size: 15px; text-align: end; padding-right:10px;">ê±°ë˜ëŒ€ê¸ˆ ìˆœ</div>
            </div>
<!--            1~10ìˆœìœ„-->
            <!-- ğŸ”¥ ka10032 ìƒìœ„ 10ê°œ ë£¨í”„ -->
            <div id="stockRows">
                <th:block th:each="item : ${ranks}">
                <!-- ë§í¬: /stock/order?code=005930 ì´ëŸ° ì‹ -->
                <a th:href="@{/stock/order(code=${item.code}, name=${item.name})}">
                    <div class="stock-row">
                        <!-- ìˆœìœ„ + ì¢…ëª©ëª… -->
                        <div style="display:flex; padding-left:14px;">
                            <div style="margin-right:20px;">
                                <div style="text-align:center; width:20px;"
                                     th:text="${item.rank}">1</div>
                            </div>
                            <div class="stock-name"
                                 th:text="${item.name}">ì‚¼ì„±ì „ì</div>
                        </div>

                        <!-- í˜„ì¬ê°€ -->
                        <div style="text-align:end;">
                    <span th:text="${#numbers.formatInteger(item.price,0,'COMMA')}">
                        152000
                    </span>ì›
                        </div>

                        <!-- ë“±ë½ë¥ : ìƒ‰ìƒ class ë¶€ì—¬ -->
                        <div style="text-align:end;"
                             th:classappend="${
                        item.changeRate > 0 ? ' rate-up' :
                        (item.changeRate < 0 ? ' rate-down' : ' rate-zero')
                     }">
                    <span th:text="${
                        (item.changeRate > 0 ? '+' : (item.changeRate < 0 ? '-' : ''))
                        + #numbers.formatDecimal(T(java.lang.Math).abs(item.changeRate), 1, 2)
                        + '%'
                    }">-0.07%</span>
                        </div>

                        <!-- ê±°ë˜ëŒ€ê¸ˆ: ë‹¨ìœ„ëŠ” ë¬¸ì„œ ê¸°ì¤€ìœ¼ë¡œ ì¡°ì • (ì˜ˆ: ì–µ ë‹¨ìœ„ë¡œ ë³´ê³  ì‹¶ìœ¼ë©´ /10000 ë“±) -->
                        <div style="text-align:end; padding-right:10px;">
                    <span th:text="${#numbers.formatInteger(item.amount, 0, 'COMMA')} + ' ë§Œì›'">
                        5,308,092
                    </span>
                        </div>
                    </div>
                </a>
            </th:block>
            </div>
        </div>
    </main>

    <footer>
        <div th:replace="~{layouts/footer.html}"></div>
    </footer>
    <!-- ë“±ë½ë¥  ìµœì € ì¢…ëª© í† ìŠ¤íŠ¸ -->
    <div id="rankToast" class="toast">
    <span class="toast-icon">
        <svg width="14" height="14" viewBox="0 0 14 14" fill="none"
             xmlns="http://www.w3.org/2000/svg">
            <path d="M11.5 4L6 9.5L3.5 7"
                  stroke="white" stroke-width="1.6"
                  stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
    </span>
        <span id="rankToastText">-</span>
    </div>

    <div id="tickerBar" class="ticker-bar">
        <div id="tickerContent" class="ticker-content" >
            <!-- âœ… ìµœì´ˆ ì§„ì… ì‹œ ì„œë²„ì—ì„œ ë¨¼ì € ì±„ìš°ê¸° -->
            <th:block th:each="item : ${ranks}">
            <span style="margin-right:40px;">
                <span th:text="${item.name}">ì‚¼ì„±ì „ì</span>
                <span th:class="${
                    item.changeRate > 0 ? 'ticker-rate-up' :
                    (item.changeRate < 0 ? 'ticker-rate-down' : 'ticker-rate-zero')
                }">
                    <span th:text="${#numbers.formatInteger(item.price,0,'COMMA')}">72,300</span>ì›
                    (
                    <span th:text="${
                        (item.changeRate > 0 ? '+' : (item.changeRate < 0 ? '-' : '')) +
                        #numbers.formatDecimal(T(java.lang.Math).abs(item.changeRate), 1, 2)
                    } + '%'">+1.23%</span>
                    )
                </span>
            </span>
            </th:block>
        </div>
    </div>
    <script>
        // ì¼ë°˜ íƒ­ active ì²˜ë¦¬ (ìœ„ìª½ íƒ­)
        function initTabs(ulId) {
            const tabList = document.getElementById(ulId);
            if (!tabList) return;

            const links = tabList.querySelectorAll('.tab-link');

            links.forEach(link => {
                link.addEventListener('click', function (e) {
                    e.preventDefault();
                    links.forEach(l => l.classList.remove('active'));
                    this.classList.add('active');
                });
            });
        }

        // ë°‘ì¤„ì´ ì›€ì§ì´ëŠ” íƒ­ ì²˜ë¦¬ (ì•„ë˜ìª½ íƒ­)
        function initMovingUnderline(ulId, underlineId) {
            const tabList = document.getElementById(ulId);
            const underline = document.getElementById(underlineId);
            if (!tabList || !underline) return;

            const links = tabList.querySelectorAll('.tab-link');

            // liì˜ offset ê¸°ì¤€ìœ¼ë¡œ ë°‘ì¤„ ì´ë™
            function moveUnderline(target) {
                const li = target.parentElement;    // <li>
                underline.style.width = li.offsetWidth + 'px';
                underline.style.left  = li.offsetLeft + 'px';
            }

            // ì´ˆê¸° ìœ„ì¹˜: active ë˜ì–´ìˆëŠ” íƒ­ ê¸°ì¤€
            const activeLink = tabList.querySelector('.tab-link.active') || links[0];
            if (activeLink) {
                moveUnderline(activeLink);
            }

            links.forEach(link => {
                link.addEventListener('click', function (e) {
                    e.preventDefault();

                    // active ì²˜ë¦¬
                    links.forEach(l => l.classList.remove('active'));
                    this.classList.add('active');

                    // ë°‘ì¤„ ì´ë™
                    moveUnderline(this);
                });
            });

            // ë¦¬ì‚¬ì´ì¦ˆ ì‹œ ìœ„ì¹˜ ë‹¤ì‹œ ê³„ì‚°
            window.addEventListener('resize', () => {
                const currentActive = tabList.querySelector('.tab-link.active') || links[0];
                if (currentActive) moveUnderline(currentActive);
            });
        }

        document.addEventListener('DOMContentLoaded', function () {
            initTabs('marketTabs');                          // ìœ„ìª½ íƒ­
            initMovingUnderline('subTabs', 'subTabsUnderline'); // ì•„ë˜ìª½ ì›€ì§ì´ëŠ” ì–¸ë”ë¼ì¸ íƒ­
        });
    </script>
<script>
    function updateTime() {
        const now = new Date();

        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');

        const text = `ìˆœìœ„Â·ì˜¤ëŠ˜ ${hours}:${minutes} ê¸°ì¤€`;

        document.getElementById('timeDisplay').innerText = text;
    }

    document.addEventListener('DOMContentLoaded', function () {
        initTabs('marketTabs');
        initMovingUnderline('subTabs', 'subTabsUnderline');

        updateTime();            // ì²˜ìŒ ì‹¤í–‰
        setInterval(updateTime, 60 * 1000);  // 1ë¶„ë§ˆë‹¤ ê°±ì‹ 
    });
</script>
    <script>
        function getRandomColor() {
            const colors = ["#1E90FF", "#FF6347", "#6A5ACD", "#2E8B57", "#FF8C00", "#DC143C"];
            return colors[Math.floor(Math.random() * colors.length)];
        }

        function getColorForName(name) {
            const key = `badgeColor_${name}`;

            // ì´ë¯¸ ì €ì¥ëœ ìƒ‰ì´ ìˆë‹¤ë©´ ê·¸ëŒ€ë¡œ ì‚¬ìš©
            const stored = localStorage.getItem(key);
            if (stored) return stored;

            // ì—†ìœ¼ë©´ ìƒˆë¡œ ìƒì„±
            const newColor = getRandomColor();
            localStorage.setItem(key, newColor);
            return newColor;
        }

        function createCircleBadge(text, color) {
            const badge = document.createElement("div");
            badge.className = "circle-badge";
            badge.style.backgroundColor = color;
            badge.textContent = text;
            return badge;
        }

        function initCircleBadges() {
            const names = document.querySelectorAll(".stock-name");

            names.forEach(nameEl => {
                const fullName = nameEl.innerText.trim();
                const firstChar = fullName.charAt(0);

                // í•­ìƒ ë™ì¼í•œ ìƒ‰ì„ ê°€ì ¸ì˜¤ê±°ë‚˜ ìƒì„±
                const color = getColorForName(fullName);

                const badge = createCircleBadge(firstChar, color);

                const wrapper = document.createElement("div");
                wrapper.style.display = "flex";
                wrapper.style.alignItems = "center";

                const originalText = document.createElement("span");
                originalText.textContent = fullName;

                wrapper.appendChild(badge);
                wrapper.appendChild(originalText);

                nameEl.innerHTML = "";
                nameEl.appendChild(wrapper);
            });
        }

        document.addEventListener("DOMContentLoaded", function () {
            initCircleBadges();
        });
    </script>
    <script>
        // ğŸ”¹ ì´ì „ ë­í‚¹ ë°ì´í„° ì €ì¥ìš©
        let prevRanksByCode = {};
        let rankToastShown = false;

        async function fetchRanks() {
            try {
                console.log('[fetchRanks] í˜¸ì¶œ');

                const res = await fetch('/BNK/api/ranks', {
                    method: 'GET',
                    cache: 'no-store'
                });

                if (!res.ok) {
                    throw new Error('failed to fetch ranks: ' + res.status);
                }

                const ranks = await res.json();
                console.log('[fetchRanks] ë°ì´í„°:', ranks);
                renderRanks(ranks);   // ğŸ”¥ ì—¬ê¸°ì„œ í† ìŠ¤íŠ¸ê¹Œì§€ ê°™ì´ ì²˜ë¦¬ë¨
                updateTicker(ranks);
            } catch (e) {
                console.error('ë­í‚¹ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', e);
            }
        }

        function renderRanks(ranks) {
            const container = document.getElementById('stockRows');
            if (!container) return;

            let html = '';
            let minItem = null;

            ranks.forEach(item => {
                const rank   = item.rank;
                const code   = item.code;
                const name   = item.name;
                const price  = Number(item.price);
                const rate   = Number(item.changeRate);
                const amount = Number(item.amount);

                if (!isNaN(rate)) {
                    if (!minItem || rate < Number(minItem.changeRate)) {
                        minItem = item;
                    }
                }

                const prev = prevRanksByCode[code];
                let rateChangeClass = '';

                if (prev) {
                    if (rate > prev.rate) {
                        rateChangeClass = 'rate-change-up';
                    } else if (rate < prev.rate) {
                        rateChangeClass = 'rate-change-down';
                    }
                }

                const rateClass =
                    rate > 0 ? 'rate-up' :
                        (rate < 0 ? 'rate-down' : 'rate-zero');

                const sign =
                    rate > 0 ? '+' :
                        (rate < 0 ? '-' : '');

                const absRate  = Math.abs(rate).toFixed(2);
                const rateText = `${sign}${absRate}%`;
                const priceText  = price.toLocaleString('ko-KR');
                const amountText = amount.toLocaleString('ko-KR') + ' ë§Œì›';

                const url = `/BNK/stock/order?code=${encodeURIComponent(code)}&name=${encodeURIComponent(name)}`;

                html += `
                <a href="${url}">
                    <div class="stock-row">
                        <div style="display:flex; padding-left:14px;">
                            <div style="margin-right:20px;">
                                <div style="text-align:center; width:20px;">
                                    ${rank}
                                </div>
                            </div>
                            <div class="stock-name">
                                ${name}
                            </div>
                        </div>
                        <div style="text-align:end;">
                            <span>${priceText}</span>ì›
                        </div>
                        <div style="text-align:end;" class="${rateClass}">
                            <span class="rate-span ${rateChangeClass}">${rateText}</span>
                        </div>
                        <div style="text-align:end; padding-right:10px;">
                            <span>${amountText}</span>
                        </div>
                    </div>
                </a>
            `;
            });

            container.innerHTML = html;

            prevRanksByCode = {};
            ranks.forEach(item => {
                prevRanksByCode[item.code] = {
                    price: Number(item.price),
                    rate:  Number(item.changeRate),
                    amount: Number(item.amount)
                };
            });

            if (typeof initCircleBadges === 'function') {
                initCircleBadges();
            }

            // âœ… ì—¬ê¸°ì„œ í† ìŠ¤íŠ¸
            if (!rankToastShown && minItem) {
                rankToastShown = true;
                showRankToast(minItem.name, Number(minItem.changeRate));
            }
        }

        function showRankToast(stockName, rate) {
            const toast = document.getElementById('rankToast');
            const text  = document.getElementById('rankToastText');
            if (!toast || !text) return;

            const absRate = Math.abs(rate).toFixed(2);

            text.innerHTML =
                `ì˜¤ëŠ˜ ê°€ì¥ ë§ì´ í•˜ë½í•œ ì¢…ëª©ì€ <b>${stockName}</b>ì—ìš”` +
                `<br><span style="font-size:12px;opacity:0.8;">` +
                `ë“±ë½ë¥  <b>${rate < 0 ? '-' : ''}${absRate}%</b>` +
                `</span>`;

            toast.classList.add('show');

            clearTimeout(window._rankToastTimer);
            window._rankToastTimer = setTimeout(function () {
                toast.classList.remove('show');
            }, 1500);
        }

        // âœ… í˜ì´ì§€ ë¡œë“œ ì‹œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° + ì£¼ê¸°ì  ê°±ì‹ 
        document.addEventListener('DOMContentLoaded', function () {
            fetchRanks();                  // ì²˜ìŒ í•œ ë²ˆ
            setInterval(fetchRanks, 1500); // 1.5ì´ˆë§ˆë‹¤ ê°±ì‹  (ì›ë˜ ìˆë˜ ë¡œì§)
        });
    </script>
    <script>
        function updateTicker(ranks) {
            const html = ranks.map(r => {
                const rate = Number(r.changeRate);
                const price = Number(r.price);

                const rateClass =
                    rate > 0 ? 'ticker-rate-up' :
                        rate < 0 ? 'ticker-rate-down' :
                            'ticker-rate-zero';

                const sign =
                    rate > 0 ? '+' :
                        rate < 0 ? '-' : '';

                const absRate = Math.abs(rate).toFixed(2);
                const priceText = price.toLocaleString('ko-KR');

                return `
            <span style="margin-right:40px;">
                ${r.name}
                <span class="${rateClass}">
                    ${priceText}ì› (${sign}${absRate}%)
                </span>
            </span>
        `;
            }).join('');

            // ëŠê¹€ ì—†ì´ ëŒê²Œ 2ë²ˆ ì´ì–´ë¶™ì´ê¸° (ì›í•˜ë©´ ìœ ì§€)
            document.getElementById('tickerContent').innerHTML = html + html;
        }
    </script>

</body>
</html>