<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>퇴직연금 기업뱅킹 - 직원 조회</title>

    <style>
        /***********************************
         * 공통 레이아웃
         ***********************************/
        * { box-sizing: border-box; }

        body {
            margin: 0;
            padding: 0;
            font-family: "Noto Sans KR", sans-serif;
            background: #f4f5f9;
            color: #222;
            font-size: 15px;
        }

        .page-container {
            max-width: 1100px;
            margin: 40px auto;
            padding: 24px;
        }

        h1 { margin: 0 0 16px; font-size: 24px; }
        .subtitle { font-size: 15px; color: #777; margin-bottom: 24px; }

        /***********************************
         * 검색/필터
         ***********************************/
        .toolbar {
            display: flex;
            gap: 12px;
            align-items: center;
            margin-bottom: 16px;
            position: relative;
        }

        .toolbar input, .toolbar select {
            padding: 8px 10px;
            border-radius: 6px;
            border: 1px solid #ccc;
            font-size: 15px;
        }

        .toolbar input { flex: 1; }

        .toolbar button {
            padding: 8px 14px;
            border-radius: 6px;
            background: #d91a1a;
            color: #fff;
            border: none;
            cursor: pointer;
        }

        .toolbar button:hover { opacity: .9; }

        /* 자동완성 */
        .auto-box {
            position: absolute;
            top: 42px;
            left: 0;
            width: 100%;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 6px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.08);
            display: none;
            max-height: 200px;
            overflow-y: auto;
            z-index: 5000;
        }

        .auto-item { padding: 8px 12px; cursor: pointer; }
        .auto-item:hover { background: #fff5f5; color: #d91a1a; }

        /***********************************
         * 카드
         ***********************************/
        .card {
            background: white;
            border-radius: 8px;
            padding: 16px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.06);
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
        }

        /***********************************
         * 테이블
         ***********************************/
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 15px;
        }

        th, td {
            padding: 10px 12px;
            border-bottom: 1px solid #eee;
            white-space: nowrap;
        }

        thead { background: #fafafa; }
        tbody tr:hover { background: #f9f1f1; }

        .tag {
            padding: 3px 8px;
            border-radius: 999px;
            font-size: 13px;
        }

        .tag-db { background: #ffe4e4; color: #b01010; }
        .tag-dc { background: #e5f2ff; color: #0b5ebf; }

        /* 상태 셀 */
        .status-select {
            padding: 6px 8px;
            border-radius: 6px;
            border: 1px solid #ccc;
            font-size: 14px;
            background: #fff;
        }

        /***********************************
         * 관리 버튼 (···)
         ***********************************/
        .manage-cell {
            text-align: right;
            width: 40px;
            position: relative;
        }

        .more-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 18px;
            color: #666;
            padding: 4px;
        }

        .more-btn:hover { color: #d91a1a; }

        .more-menu-wrapper { position: relative; display: inline-block; }

        .more-menu {
            position: absolute;
            top: 26px;
            right: 0;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            min-width: 120px;
            display: none;
            z-index: 9999;
        }

        .more-menu a {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 12px;
            font-size: 14px;
            text-decoration: none;
            color: #222;
        }

        .more-menu a:hover {
            background: #fff5f5;
            color: #d91a1a;
        }

        .more-menu a.delete { color: #d91a1a; }

        /***********************************
         * 모달 (퇴사일 입력)
         ***********************************/
        .modal-bg {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,.45);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 99999;
        }

        .modal-box {
            background: #fff;
            width: 330px;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.15);
            text-align: center;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 14px;
        }

        .btn-cancel, .btn-save {
            flex: 1;
            padding: 8px;
            font-size: 14px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
        }

        .btn-cancel { background: #ddd; }
        .btn-save { background: #d91a1a; color: #fff; }

        .pagination-wrapper {
            text-align: center;
            margin: 25px 0;
        }

        .pagination {
            list-style: none;
            display: inline-flex;
            gap: 6px;
            padding: 0;
        }

        .pagination li a {
            display: block;
            padding: 8px 14px;
            border: 1px solid #ddd;
            border-radius: 6px;
            text-decoration: none;
            font-size: 14px;
            color: #444;
        }

        .pagination li.active a {
            background: #d91a1a;
            color: #fff;
            border-color: #d91a1a;
        }

        .pagination li.disabled a {
            pointer-events: none;
            opacity: .4;
        }

        .btn-create {
            background:#d91a1a;
            color:#fff;
            padding:8px 14px;
            border-radius:6px;
            text-decoration:none;
            font-size:14px;
        }
        .btn-create:hover { opacity:.9; }

    </style>
</head>

<body>

<div th:replace="~{layouts/corporate_header :: corpHeader}"></div>
<script>initCorporateHeader("employee");</script>

<div class="page-container">

    <h1>퇴직연금 직원 조회</h1>
    <div class="subtitle">EMPLOYEE 테이블 기반 직원별 제도, 계좌, 재직 상태를 조회·관리합니다.</div>

    <!-- 관리 / CRUD 상단 메뉴 -->
    <div class="admin-toolbar" style="
    display:flex;
    justify-content:space-between;
    align-items:center;
    background:#fff;
    padding:14px 18px;
    border-radius:8px;
    border:1px solid #ddd;
    margin-bottom:20px;
">
        <div style="font-size:16px; font-weight:600;">직원 관리</div>

        <div>
            <a href="/corporate/employee/create"
               style="background:#d91a1a; color:#fff; padding:8px 14px; border-radius:6px; text-decoration:none;">
                직원 등록
            </a>
        </div>
    </div>

    <!-- 검색 -->
    <form method="get" th:action="@{/corporate/employee/list}">
        <div class="toolbar">
            <input type="text" id="searchKeyword" name="keyword"
                   th:value="${keyword}" placeholder="직원 이름 또는 계좌번호 검색">

            <div id="autoBox" class="auto-box"></div>

            <select name="planType">
                <option value="" th:selected="${planType == ''}">전체 제도</option>
                <option value="DB" th:selected="${planType == 'DB'}">DB 제도</option>
                <option value="DC" th:selected="${planType == 'DC'}">DC 제도</option>
            </select>

            <button type="submit">검색</button>
            <button type="button" onclick="location.href='/BNK/corporate/employee/list'">초기화</button>
        </div>
    </form>

    <!-- 직원 목록 -->
    <div class="card">
        <div class="card-title">직원 목록</div>

        <table>
            <thead>
            <tr>
                <th>직원ID</th>
                <th>이름</th>
                <th>제도</th>
                <th>계좌번호</th>
                <th>재직 상태</th>
                <th></th>
            </tr>
            </thead>

            <tbody>
            <tr th:each="emp : ${employees}">
                <td th:text="${emp.empId}"></td>

                <!-- 이름 클릭 시 상세 이동 -->
                <td>
                    <a th:href="@{/BNK/corporate/employee/detail/{id}(id=${emp.empId})}"
                       style="text-decoration:none; color:#222; font-weight:600;">
                        <span th:text="${emp.name}"></span>
                    </a>
                </td>

                <td>
                    <span th:class="'tag ' + (${emp.planType} == 'DB' ? 'tag-db' : 'tag-dc')"
                          th:text="${emp.planType}"></span>
                </td>

                <td th:text="${emp.accountNo}"></td>

                <!-- 상태 변경 -->
                <td>
                    <select class="status-select"
                            th:data-id="${emp.empId}"
                            th:data-old="${emp.status}">
                        <option value="ACTIVE" th:selected="${emp.status=='ACTIVE'}">재직</option>
                        <option value="LEAVE" th:selected="${emp.status=='LEAVE'}">휴직</option>
                        <option value="RETIRE" th:selected="${emp.status=='RETIRE'}">퇴사</option>
                    </select>
                </td>

                <!-- 관리 메뉴 -->
                <td class="manage-cell">
                    <div class="more-menu-wrapper">
                        <button class="more-btn"><i class="fa-solid fa-ellipsis-vertical"></i></button>
                        <div class="more-menu">
                            <a th:href="@{/corporate/employee/edit/{id}(id=${emp.empId})}">
                                수정
                            </a>
                            <a class="delete" th:href="@{/corporate/employee/delete/{id}(id=${emp.empId})}">
                                삭제
                            </a>
                        </div>
                    </div>
                </td>

            </tr>
            </tbody>
        </table>

        <!-- ⭐⭐⭐ 페이지네이션 영역 추가 ⭐⭐⭐ -->
        <div class="pagination-wrapper">
            <ul class="pagination">

                <!-- 이전 버튼 -->
                <li th:class="${page == 1} ? 'disabled'">
                    <a th:href="@{/corporate/employee/list(keyword=${keyword}, planType=${planType}, page=${page - 1})}">
                        이전
                    </a>
                </li>

                <!-- 페이지 번호 -->
                <li th:each="p : ${#numbers.sequence(1, totalPages)}"
                    th:class="${p == page} ? 'active'">
                    <a th:href="@{/corporate/employee/list(keyword=${keyword}, planType=${planType}, page=${p})}">
                        [[${p}]]
                    </a>
                </li>

                <!-- 다음 버튼 -->
                <li th:class="${page == totalPages} ? 'disabled'">
                    <a th:href="@{/corporate/employee/list(keyword=${keyword}, planType=${planType}, page=${page + 1})}">
                        다음
                    </a>
                </li>

            </ul>
        </div>
    </div>
</div>

<!-- 퇴사일 모달 -->
<div id="retireModal" class="modal-bg">
    <div class="modal-box">
        <h3>퇴사일 입력</h3>
        <input type="date" id="retireDate" style="padding:8px; width:100%; margin-top:10px;">
        <div class="modal-buttons">
            <button class="btn-cancel" onclick="closeRetireModal()">취소</button>
            <button class="btn-save" onclick="saveRetireDate()">저장</button>
        </div>
    </div>
</div>

<script>
    /***************************************************
     * 자동완성
     ***************************************************/
    const input = document.getElementById("searchKeyword");
    const autoBox = document.getElementById("autoBox");
    let debounceTimer;

    async function loadAuto(keyword) {
        if (!keyword) {
            autoBox.style.display = "none";
            return;
        }

        const res = await fetch(`/BNK/corporate/employee/autocomplete?keyword=${keyword}`);
        const list = await res.json();

        autoBox.innerHTML = list.map(emp =>
            `<div class="auto-item" onclick="location.href='/BNK/corporate/employee/detail/${emp.empId}'">
            ${emp.name} (${emp.accountNo})
        </div>`
        ).join("");

        autoBox.style.display = list.length ? "block" : "none";
    }

    input.addEventListener("input", () => {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => loadAuto(input.value.trim()), 300);
    });

    document.addEventListener("click", (e) => {
        if (!e.target.closest(".auto-box") && e.target.id !== "searchKeyword") {
            autoBox.style.display = "none";
        }
    });

    /***************************************************
     * 더보기 메뉴 (···)
     ***************************************************/
    document.addEventListener("click", e => {
        const isBtn = e.target.closest(".more-btn");
        const menus = document.querySelectorAll(".more-menu");
        menus.forEach(m => m.style.display = "none");

        if (isBtn) {
            const menu = isBtn.closest(".more-menu-wrapper").querySelector(".more-menu");
            menu.style.display = "block";
            e.stopPropagation();
        }
    });

    /***************************************************
     * 상태 변경 + 확인 + 퇴사 모달
     ***************************************************/
    let retireEmpId = null;
    let retireSelectObj = null;

    document.querySelectorAll(".status-select").forEach(sel => {
        sel.addEventListener("change", function () {

            const empId = this.dataset.id;
            const newStatus = this.value;
            const oldStatus = this.dataset.old;

            // confirm
            if (!confirm(`상태를 '${oldStatus}' → '${newStatus}' 로 변경하시겠습니까?`)) {
                this.value = oldStatus;
                return;
            }

            // 퇴사 선택 시 모달
            if (newStatus === "RETIRE") {
                retireEmpId = empId;
                retireSelectObj = this;
                document.getElementById("retireModal").style.display = "flex";
                return;
            }

            // 재직/휴직 → 즉시 업데이트
            updateStatus(empId, newStatus, this);
        });
    });

    /* 공통 AJAX */
    async function updateStatus(empId, status, selectObj) {
        const res = await fetch(`/BNK/corporate/employee/status/${empId}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ status })
        });

        if (res.ok) {
            alert("상태 변경 완료");
            selectObj.dataset.old = status;
        } else {
            alert("상태 변경 실패");
            selectObj.value = selectObj.dataset.old;
        }
    }

    /***************************************************
     * 퇴사일 모달
     ***************************************************/
    function closeRetireModal() {
        document.getElementById("retireModal").style.display = "none";
        if (retireSelectObj)
            retireSelectObj.value = retireSelectObj.dataset.old;
    }

    async function saveRetireDate() {
        const date = document.getElementById("retireDate").value;
        console.log("▶ saveRetireDate() 실행됨");
        console.log("▶ 선택한 날짜:", date);
        console.log("▶ retireEmpId:", retireEmpId);

        if (!date) {
            alert("퇴사일을 선택해주세요.");
            return;
        }

        const url = `/BNK/corporate/employee/retire/${retireEmpId}`;
        console.log("▶ 호출 URL:", url);

        const bodyData = {
            status: "RETIRE",
            retireDate: date
        };

        console.log("▶ 요청 Body:", bodyData);

        const res = await fetch(url, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(bodyData)
        });

        console.log("▶ 서버 응답 상태:", res.status);

        if (res.ok) {
            alert("퇴사 처리 완료");
            retireSelectObj.dataset.old = "RETIRE";
            document.getElementById("retireModal").style.display = "none";
        } else {
            alert("퇴사 처리 실패");
        }
    }
</script>

</body>
</html>
