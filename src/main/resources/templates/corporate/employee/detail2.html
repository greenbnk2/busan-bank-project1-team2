<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>í‡´ì§ì—°ê¸ˆ ê¸°ì—…ë±…í‚¹ - ì§ì› ì›”ë³„ ë‚©ì… ë‚´ì—­</title>

    <style>
        *:not(html) {
            font-size: min(max(16px, 1em), 30px);
        }


        body {
            margin: 0;
            font-family: 'Pretendard', 'Noto Sans KR', sans-serif;
            background: #F4F5F9;
            color: #222;
            font-size: 15px;
            overflow-x: hidden;  /* ğŸ”¥ ì¶”ê°€ í•„ìˆ˜ */
        }

        /* ================== ë©”ì¸ ë ˆì´ì•„ì›ƒ ================== */
        .page-wrapper {
            max-width: 1200px;
            margin: 40px auto;
            padding: 0 24px 80px;
        }

        /* ================== í—¤ë”: ì¢Œ(ê²€ìƒ‰ + ì œëª©) ================== */
        .page-header {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            margin-bottom: 24px;
        }

        .search-box form {
            display: flex;
            gap: 8px;
        }

        .search-input {
            padding: 8px 12px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 14px;
            width: 260px;
        }

        .search-btn {
            padding: 8px 16px;
            background: #D91A1A;
            color: #fff;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }
        .search-btn:hover { background: #B81414; }

        .title-wrap {
            margin-top: 12px;
        }
        .title-wrap h1 {
            margin: 0;
            font-size: 24px;
            font-weight: 700;
        }
        .subtitle {
            margin-top: 6px;
            font-size: 15px;
            color: #777;
        }

        /* ================== 2ë‹¨ ë¶„í•  ë ˆì´ì•„ì›ƒ ================== */
        .content-split {
            display: grid;
            grid-template-columns: 340px 1fr;
            gap: 24px;
        }

        /* ================== ì¢Œì¸¡: ì§ì› ëª©ë¡ ================== */
        .employee-list {
            background: #ffffff;
            border-radius: 12px;
            padding: 20px;
            height: 700px;
            overflow-y: auto;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
        }

        .employee-item {
            padding: 10px 0;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }

        .employee-item:hover {
            color: #D91A1A;
        }

        .employee-item .emp-name {
            font-size: 15px;
            font-weight: 600;
        }

        .employee-item .emp-info {
            font-size: 13px;
            color: #777;
            margin-top: 4px;
        }

        .employee-item .emp-info {
            font-size: 12px;
        }

        /* ================== ìš°ì¸¡: ìƒì„¸ ì •ë³´ ================== */
        .detail-panel {
            background: #ffffff;
            border-radius: 12px;
            padding: 24px 28px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
        }

        .employee-summary {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .info-row { display: flex; gap: 10px; }
        .label { min-width: 90px; font-weight: 600; color: #555; }
        .value { color: #222; }

        .total-box { text-align: right; }
        .total-box .amount {
            font-size: 22px;
            font-weight: 700;
            color: #D91A1A;
        }

        /* ================== ìë™ì™„ì„± ëª©ë¡ ================== */
        .autocomplete-box {
            position: absolute;
            background: #fff;
            border: 1px solid #ddd;
            width: 260px;
            border-radius: 6px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.08);
            display: none;
            z-index: 2000;
        }

        .autocomplete-item {
            padding: 8px 12px;
            cursor: pointer;
        }
        .autocomplete-item:hover {
            background: #f4f4f4;
        }
        /* ì›”ë³„ ë‚©ì… í…Œì´ë¸” ê³µí†µ */
        .detail-panel table th,
        .detail-panel table td {
            padding: 10px 12px;
            border-bottom: 1px solid #eee;
            font-size: 14px;
        }

        .info-row {
            padding: 6px 0;
        }
        .info-row .label {
            padding-right: 10px;
            font-weight: 600;
            color: #555;
        }
        .info-row .value {
            padding-left: 4px;
        }

        /* ================== ì›”ë³„ ë‚©ì… í•„í„°ë°” ================== */
        .contrib-filter-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 12px 0;
        }

        .contrib-filter-bar .left {
            display: flex;
            gap: 8px;
        }

        .contrib-filter-bar select {
            padding: 6px 10px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 13px;
            background: #fff;
            cursor: pointer;
        }

        .sort-toggle-btn {
            padding: 6px 14px;
            border: 1px solid #ccc;
            border-radius: 6px;
            background: #fff;
            cursor: pointer;
            font-size: 13px;
        }

        .sort-toggle-btn.active {
            background: #D91A1A;
            color: #fff;
            border-color: #D91A1A;
        }

        .page-wrapper {
            padding-left: 40px;
        }

    </style>
</head>

<body>

<!-- ğŸ”¥ corporate_header.html ë¡œë“œ (ì‚¬ì´ë“œë°”+í–„ë²„ê±° í¬í•¨) -->
<div th:replace="~{layouts/corporate_header :: corpHeader}"></div>


<!-- â­ í˜ì´ì§€ ë³¸ë¬¸ -->
<div class="page-wrapper">

    <!-- ================== í˜ì´ì§€ í—¤ë” ================== -->
    <header class="page-header">
        <div class="title-wrap">
            <h1>ì§ì› ì›”ë³„ ë‚©ì… ë‚´ì—­</h1>
            <p class="subtitle">ì›”ë³„ ë‚©ì…ì•¡ âˆ™ ëˆ„ì  ì ë¦½ê¸ˆ ìƒì„¸ ì¡°íšŒ</p>
        </div>
        <div class="search-box">
            <form>
                <div style="position:relative;">
                    <input type="text" id="searchInput" class="search-input" placeholder="ì§ì›ëª… ë˜ëŠ” ê³„ì¢Œë²ˆí˜¸ ê²€ìƒ‰">
                    <div id="autocompleteList" class="autocomplete-box"></div>
                </div>
                <button class="search-btn">ê²€ìƒ‰</button>
            </form>
        </div>
    </header>

    <!-- ================== 2ë‹¨ ë¶„í•  ================== -->
    <section class="content-split">

        <!-- ========== LEFT: ì§ì› ëª©ë¡ ========= -->
        <div class="employee-list" id="employeeList"></div>

        <!-- ========== RIGHT: ìƒì„¸ ========= -->
        <div class="detail-panel">

            <section class="employee-summary">
                <div>
                    <div class="info-row"><span class="label">ì§ì› ID</span><span class="value" id="empId"></span></div>
                    <div class="info-row"><span class="label">ì§ì›ëª…</span><span class="value" id="empName"></span></div>
                    <div class="info-row"><span class="label">ê³„ì¢Œë²ˆí˜¸</span><span class="value" id="accountNo"></span></div>
                </div>

                <div class="total-box">
                    <div class="label">í˜„ì¬ ì ë¦½ê¸ˆ</div>
                    <div class="amount" id="currentBalance">0ì›</div>
                </div>
            </section>

            <h3 style="margin-bottom:12px;">ì›”ë³„ ë‚©ì… ë‚´ì—­</h3>

            <!-- ğŸ”½ ì •ë ¬/í•„í„° ë°” ì¶”ê°€ -->
            <div class="contrib-filter-bar">
                <div class="left">
                    <select id="yearFilter" onchange="applyContributionFilters()">
                        <option value="">ì „ì²´ ì—°ë„</option>
                    </select>

                    <select id="quarterFilter" onchange="applyContributionFilters()">
                        <option value="">ì „ì²´ ë¶„ê¸°</option>
                        <option value="Q1">1ë¶„ê¸°</option>
                        <option value="Q2">2ë¶„ê¸°</option>
                        <option value="Q3">3ë¶„ê¸°</option>
                        <option value="Q4">4ë¶„ê¸°</option>
                    </select>
                </div>

                <button id="sortToggleBtn" class="sort-toggle-btn" onclick="toggleSortOrder()">ìµœì‹ ìˆœ</button>
            </div>
            <!-- ğŸ”¼ ì—¬ê¸°ê¹Œì§€ -->

            <table style="width:100%; border-collapse:collapse;">
                <thead style="background:#f4f4f6;">
                <tr>
                    <th>ë…„ì›”</th>
                    <th style="text-align:right;">ì›”ë³„ ë‚©ì…ì•¡</th>
                    <th style="text-align:right;">ëˆ„ì  ì ë¦½ê¸ˆ</th>
                </tr>
                </thead>
                <tbody id="contribBody"></tbody>
            </table>
        </div>

    </section>

</div>


<script th:inline="javascript">
    /* ==============================
       ë°ì´í„° (Thymeleaf ë°”ì¸ë”©)
    ============================== */
    const employeeList = /*[[${employees}]]*/ [];
    const detailEmployee = /*[[${employee}]]*/ {};
    const contributions = /*[[${contributions}]]*/ [];
    const currentBalance = /*[[${currentBalance}]]*/ 0;

    /* ==============================
       ì¢Œì¸¡ ëª©ë¡ ë Œë”ë§
    ============================== */
    function renderEmployeeList() {
        const listDom = document.getElementById("employeeList");
        listDom.innerHTML = "";

        employeeList.forEach(emp => {
            listDom.innerHTML += `
            <div class="employee-item" onclick="location.href='/BNK/corporate/employee/detail/${emp.empId}'">
                <div class="emp-name">${emp.name}</div>
                <div class="emp-info">ì§ì› ID : ${emp.empId}</div>
                <div class="emp-info">ê³„ì¢Œë²ˆí˜¸ : ${emp.accountNo}</div>
            </div>
        `;
        });
    }

    /* ==============================
       ìƒì„¸ ì •ë³´ ë Œë”ë§
    ============================== */
    let isLatestFirst = true; // true: ìµœì‹ ìˆœ, false: ê³¼ê±°ìˆœ

    function renderDetail() {
        // ì§ì› ê¸°ë³¸ ì •ë³´
        document.getElementById('empName').textContent = detailEmployee.name;
        document.getElementById('empId').textContent = detailEmployee.empId;
        document.getElementById('accountNo').textContent = detailEmployee.accountNo;
        document.getElementById('currentBalance').textContent = currentBalance.toLocaleString("ko-KR") + "ì›";

        // ì—°ë„ ì˜µì…˜ ì…‹ì—…
        fillYearOptions();

        // ì´ˆê¸° í•„í„° ì ìš©
        applyContributionFilters();
    }

    // ì—°ë„ select ìë™ ìƒì„±
    function fillYearOptions() {
        const yearSel = document.getElementById("yearFilter");
        // ê¸°ì¡´ ì˜µì…˜(ì „ì²´ ì—°ë„) ìœ ì§€í•œ ì±„ë¡œ ë‚˜ë¨¸ì§€ ì±„ìš°ê¸° ìœ„í•´ í•œë²ˆ ë¹„ìš°ê³  ë‹¤ì‹œ ë„£ì–´ë„ ë¨
        const baseOption = `<option value="">ì „ì²´ ì—°ë„</option>`;
        yearSel.innerHTML = baseOption;

        const years = [...new Set(contributions.map(c => c.yearMonth.slice(0,4)))];
        years.sort().reverse(); // ìµœì‹  ì—°ë„ ë¨¼ì €

        years.forEach(y => {
            yearSel.innerHTML += `<option value="${y}">${y}ë…„</option>`;
        });
    }

    // ìµœì‹ ìˆœ/ê³¼ê±°ìˆœ í† ê¸€ ë²„íŠ¼
    function toggleSortOrder() {
        isLatestFirst = !isLatestFirst;
        const btn = document.getElementById("sortToggleBtn");
        btn.textContent = isLatestFirst ? "ìµœì‹ ìˆœ" : "ê³¼ê±°ìˆœ";
        btn.classList.toggle("active", isLatestFirst);

        applyContributionFilters();
    }

    // ì—°ë„/ë¶„ê¸°/ì •ë ¬ ëª¨ë‘ ë°˜ì˜í•´ì„œ í…Œì´ë¸” ë Œë”ë§
    function applyContributionFilters() {
        const year = document.getElementById("yearFilter").value;
        const quarter = document.getElementById("quarterFilter").value;

        let filtered = [...contributions];

        // ì—°ë„ í•„í„°
        if (year) {
            filtered = filtered.filter(c => c.yearMonth.startsWith(year));
        }

        // ë¶„ê¸° í•„í„°
        if (quarter) {
            filtered = filtered.filter(c => {
                const month = parseInt(c.yearMonth.slice(4,6));
                if (quarter === "Q1") return month >= 1 && month <= 3;
                if (quarter === "Q2") return month >= 4 && month <= 6;
                if (quarter === "Q3") return month >= 7 && month <= 9;
                if (quarter === "Q4") return month >= 10 && month <= 12;
            });
        }

        // í…Œì´ë¸” ì •ë ¬ (ë³´ì—¬ì£¼ëŠ” ìˆœì„œ)
        filtered.sort((a, b) => {
            return isLatestFirst
                ? b.yearMonth.localeCompare(a.yearMonth)
                : a.yearMonth.localeCompare(b.yearMonth);
        });

        // ================================================
        //      ğŸ”¥ ëˆ„ì í•© ê³„ì‚° ë¡œì§ â€” ì‹œê°„ ì˜¤ë¦„ì°¨ìˆœ ê³ ì •
        // ================================================
        const calcBase = [...filtered].sort((a, b) =>
            a.yearMonth.localeCompare(b.yearMonth)
        );

        let cumulativeMap = {};
        let running = 0;
        calcBase.forEach(row => {
            running += row.amount;
            cumulativeMap[row.yearMonth] = running;
        });

        // ================================================
        //       ìµœì¢… ì¶œë ¥ (ì •ë ¬ëœ filtered ìˆœì„œ ìœ ì§€)
        // ================================================
        const body = document.getElementById("contribBody");
        body.innerHTML = "";

        filtered.forEach(row => {
            const cum = cumulativeMap[row.yearMonth];

            body.innerHTML += `
            <tr>
                <td>${row.yearMonth.slice(0,4)}-${row.yearMonth.slice(4,6)}</td>
                <td style="text-align:right;">${row.amount.toLocaleString("ko-KR")}ì›</td>
                <td style="text-align:right;">${cum.toLocaleString("ko-KR")}ì›</td>
            </tr>
        `;
        });
    }


    /* ===========================
       ìë™ì™„ì„± ê¸°ëŠ¥ (ê¸°ì¡´ ìœ ì§€)
    =========================== */
    let autoIndex = -1;
    let autoItems = [];

    /* Debounce í•¨ìˆ˜ */
    let debounceTimer = null;
    function debounce(callback, delay = 300) {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(callback, delay);
    }

    /* highlight í•¨ìˆ˜ (ìë™ì™„ì„±ìš©) */
    function highlight(text, keyword) {
        if (!keyword) return text;
        const reg = new RegExp(keyword, "gi");
        return text.replace(reg, m => `<b style="color:#D91A1A;">${m}</b>`);
    }

    /* ìë™ì™„ì„± ìš”ì²­ */
    async function loadAutocomplete(keyword) {
        const box = document.getElementById("autocompleteList");

        if (!keyword || keyword.length < 1) {
            box.style.display = "none";
            return;
        }

        const res = await fetch(`/BNK/corporate/employee/autocomplete?keyword=${keyword}`);
        const list = await res.json();

        autoItems = list;
        autoIndex = -1;

        box.innerHTML = list
            .map((emp, i) => `
            <div class="autocomplete-item" data-index="${i}">
                ${highlight(emp.name, keyword)} (${highlight(emp.accountNo, keyword)})
            </div>
        `)
            .join("");

        box.style.display = list.length > 0 ? "block" : "none";

        // ë§ˆìš°ìŠ¤ í´ë¦­ ì´ë²¤íŠ¸
        document.querySelectorAll(".autocomplete-item").forEach(el => {
            el.addEventListener("click", () => {
                const idx = el.dataset.index;
                selectAutocomplete(idx);
            });
        });
    }

    /* ìë™ì™„ì„± ì„ íƒ */
    function selectAutocomplete(index) {
        const item = autoItems[index];
        if (!item) return;

        searchInput.value = item.name;
        document.getElementById("autocompleteList").style.display = "none";

        // ìƒì„¸ í˜ì´ì§€ ì´ë™
        location.href = `/BNK/corporate/employee/detail/${item.empId}`;
    }

    /* ìë™ì™„ì„± active ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸ */
    function updateActiveItem() {
        const items = document.querySelectorAll(".autocomplete-item");
        items.forEach((el, i) => {
            el.classList.toggle("active", i === autoIndex);
            if (i === autoIndex) el.scrollIntoView({ block: "nearest" });
        });
    }

    /* === ì´ë²¤íŠ¸: input ì…ë ¥ ì‹œ debounce ì ìš© === */
    document.getElementById("searchInput").addEventListener("input", function () {
        const keyword = this.value.trim();
        debounce(() => loadAutocomplete(keyword), 250);
    });

    /* === ì´ë²¤íŠ¸: ë°©í–¥í‚¤ ì²˜ë¦¬ === */
    document.getElementById("searchInput").addEventListener("keydown", function (e) {
        const box = document.getElementById("autocompleteList");
        if (box.style.display === "none") return;

        if (e.key === "ArrowDown") {
            e.preventDefault();
            autoIndex = (autoIndex + 1) % autoItems.length;
            updateActiveItem();
        }

        if (e.key === "ArrowUp") {
            e.preventDefault();
            autoIndex = autoIndex <= 0 ? autoItems.length - 1 : autoIndex - 1;
            updateActiveItem();
        }

        if (e.key === "Enter") {
            e.preventDefault();
            if (autoIndex >= 0) selectAutocomplete(autoIndex);
        }

        if (e.key === "Escape") {
            box.style.display = "none";
        }
    });

    /* === focus out ì‹œ auto box ë‹«ê¸° === */
    document.addEventListener("click", (e) => {
        if (!e.target.closest(".autocomplete-box") && e.target.id !== "searchInput") {
            document.getElementById("autocompleteList").style.display = "none";
        }
    });

    /* ==============================
       ì´ˆê¸° ë Œë”ë§
    ============================== */
    document.addEventListener("DOMContentLoaded", () => {
        renderEmployeeList();
        renderDetail();
    });
</script>



</body>
</html>
