<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ì•„ì´ë”” ì°¾ê¸°</title>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
</head>
<body>
    <div th:replace="~{layouts/header.html}"></div>

<div id="bnk-chatbot-container" style="position: fixed; right: 20px; bottom: 20px; z-index: 9999;">
  <div id="bnk-chatbot-slot"></div>
</div>
<main>
  <div class="container">
    <!-- í¼ -->
    <section style="width: 650px; margin: 0 auto; margin-top: 30px;">
      <!-- ê°ì‹¸ê¸° -->
      <div class="form-card" style="height: 800px; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; line-height: 1.6;">

        <!-- ê²€ìƒ‰ ì•„ì´ì½˜ -->
        <div class="search-icon-wrapper">
            <div class="search-icon">
                <span class="material-symbols-outlined">search</span>
            </div>
        </div>

        <!-- ì œëª© -->
        <table class="login-table">
          <tr style="font-size: 25px;">
            <td>ì•„ì´ë”” ì°¾ê¸°</td>
          </tr>
          <tr>
            <td style="padding: 0 0 12px;">ê°€ì… ì‹œ ì…ë ¥í•œ ì •ë³´ë¥¼ í†µí•´ ì•„ì´ë””ë¥¼ í™•ì¸í•˜ì„¸ìš”</td>
          </tr>
        </table>

        <!-- ì¸ì¦ ë°©ì‹ ìŠ¤ìœ„ì¹˜ -->
        <div class="method-switch" role="tablist" aria-label="ì•„ì´ë”” ì°¾ê¸° ì¸ì¦ ë°©ì‹">
          <button type="button" class="method-btn active" role="tab" aria-selected="true" aria-controls="panel-phone" id="tab-phone">íœ´ëŒ€ì „í™”ë¡œ ì¸ì¦</button>
          <button type="button" class="method-btn" role="tab" aria-selected="false" aria-controls="panel-email" id="tab-email">ì´ë©”ì¼ë¡œ ì¸ì¦</button>
        </div>

        <!-- ì•„ì´ë”” ì°¾ê¸° ì…ë ¥ í…Œì´ë¸” -->
        <table class="login-table" style="margin-top: 12px;">
          <!-- íœ´ëŒ€ì „í™” ë°©ì‹ íŒ¨ë„ -->
          <tbody id="panel-phone" class="method-panel" role="tabpanel" aria-labelledby="tab-phone">
            <tr class="field-row">
              <td class="field-label">ì´ë¦„</td>
            </tr>
            <tr class="field-row">
              <td style="margin-bottom: 19px;">
                <input type="text" name="name_phone" placeholder="ì´ë¦„ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”" autocomplete="name">
              </td>
            </tr>
            <tr class="field-row">
              <td class="field-label">íœ´ëŒ€í° ë²ˆí˜¸</td>
            </tr>
            <tr class="field-row">
                <td style="margin-bottom: 19px;">
                    <div style="display: flex; align-items: center; gap: 12px; max-width: 522px">
                        <input type="text" name="member_phone"
                               placeholder="010-1234-5678" autocomplete="tel"
                               style="width: 200px; height: 40px; border:1px solid #bbb; border-radius:10px; padding:0 10px;">
                        <button type="button" class="btn-register btn-certify" id="send-sms"
                                style="height: 40px;">ì¸ì¦ìš”ì²­</button>

                        <input type="text" name="sms_code"
                               placeholder="ì¸ì¦ë²ˆí˜¸ ì…ë ¥" autocomplete="one-time-code"
                               style="width: 100px; height: 40px; border:1px solid #bbb; border-radius:10px; padding:0 10px;">
                        <button type="button" class="btn-register" id="check-sms"
                                style="height: 40px;">í™•ì¸</button>
                    </div>
                </td>
            </tr>
          </tbody>

          <!-- ì´ë©”ì¼ ë°©ì‹ íŒ¨ë„ -->
          <tbody id="panel-email" class="method-panel hidden" role="tabpanel" aria-labelledby="tab-email" aria-hidden="true">
              <tr class="field-row">
                  <td class="field-label">ì´ë¦„</td>
              </tr>
              <tr class="field-row">
                  <td style="margin-bottom: 19px;">
                      <input type="text" name="name_email" placeholder="ì´ë¦„ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”">
                  </td>
              </tr>
              <tr class="field-row">
                  <td class="field-label">ì´ë©”ì¼ ì£¼ì†Œ</td>
              </tr>
              <tr class="field-row">
                  <td style="margin-bottom: 19px;">
                      <div style="display: flex; align-items: center; gap: 12px; max-width: 522px">
                          <input type="text" name="member_email"
                                 placeholder="example@email.com" autocomplete="email"
                                 style="width: 230px; height: 40px; border:1px solid #bbb; border-radius:10px; padding:0 10px;">
                          <button type="button" class="btn-register btn-certify" id="send-mail"
                                  style="height: 40px;">ì¸ì¦ìš”ì²­</button>
                          <input type="text" name="mail_code"
                                 placeholder="ì¸ì¦ë²ˆí˜¸ ì…ë ¥" autocomplete="one-time-code"
                                 style="width: 80px; height: 40px; border:1px solid #bbb; border-radius:10px; padding:0 10px;">
                          <button type="button" class="btn-register" id="check-mail"
                                  style="height: 40px;">í™•ì¸</button>
                      </div>
                  </td>
              </tr>
          </tbody>

          <tr>
            <td class="field-td">
                <button class="btn-register" style="width: 500px;" id="btn-find-id">ì°¾ê¸°</button>
            </td>
          </tr>
        </table>

        <!-- ë²„íŠ¼ -->
        <div class="btns" style="padding-top: 20px; border-top: 1px solid #D1D5DB;">
          <a th:href="@{/member/main}" class="btn-pressable"
            style="display:inline-block; box-sizing:border-box; width: 500px; height:42px; line-height:42px; border-radius:8px; border:1px solid #D1D5DB; background-color:white; text-align:center; color:#111; text-decoration:none;">
            í™ˆìœ¼ë¡œ
          </a>          
        </div>
      </div>
    </section>
  </div>
</main>

<!-- ì•„ì´ë”” ê²°ê³¼ ëª¨ë‹¬ -->
<div id="id-result-modal" class="id-modal" aria-hidden="true">
    <div class="id-modal-backdrop" data-dismiss="modal"></div>
    <div class="id-modal-dialog">
        <div class="id-modal-header">
            <h3>ì•„ì´ë”” í™•ì¸</h3>
            <button type="button" class="id-modal-close" data-dismiss="modal">Ã—</button>
        </div>
        <div class="id-modal-body">
            <p>ê³ ê°ë‹˜ì˜ ì•„ì´ë””ëŠ” <strong id="found-id"></strong> ì…ë‹ˆë‹¤.</p>
        </div>
        <div class="id-modal-footer">
            <button type="button" class="btn-register" data-dismiss="modal">í™•ì¸</button>
        </div>
    </div>
</div>

<script>
    (function(){
        /* ì¸ì¦ ë°©ì‹ ì „í™˜ */
        const tabPhone = document.getElementById('tab-phone');
        const tabEmail = document.getElementById('tab-email');
        const panelPhone = document.getElementById('panel-phone');
        const panelEmail = document.getElementById('panel-email');

        function setActive(which){
            const isPhone = which === 'phone';
            tabPhone.classList.toggle('active', isPhone);
            tabEmail.classList.toggle('active', !isPhone);

            panelPhone.classList.toggle('hidden', !isPhone);
            panelEmail.classList.toggle('hidden', isPhone);

            panelPhone.setAttribute('aria-hidden', !isPhone);
            panelEmail.setAttribute('aria-hidden', isPhone);
        }

        tabPhone.addEventListener('click', ()=> setActive('phone'));
        tabEmail.addEventListener('click', ()=> setActive('email'));
        setActive('phone');

        /* ëª¨ë‹¬ */
        const modal = document.getElementById('id-result-modal');
        let lastFocused = null;

        function openIdModal(id){
            lastFocused = document.activeElement;
            document.getElementById('found-id').textContent = id;
            modal.classList.add('open');
            modal.setAttribute('aria-hidden', 'false');
        }
        function closeIdModal(){
            modal.classList.remove('open');
            modal.setAttribute('aria-hidden', 'true');
            if (lastFocused?.focus) lastFocused.focus();
        }
        modal.addEventListener('click', (e)=>{
            if (e.target.matches('[data-dismiss="modal"], .id-modal-backdrop')) {
                closeIdModal();
            }
        });

        /* ì¸ì¦ ìƒíƒœ */
        let phoneVerified = false;
        let emailVerified = false;

        // íœ´ëŒ€í° ì¸ì¦ë²ˆí˜¸ ë°œì†¡
        document.getElementById('send-sms')?.addEventListener('click', async () => {
            const phone = document.querySelector('input[name="member_phone"]').value.replace(/\D/g, '');

            if (!/^01\d{8,9}$/.test(phone)) {
                return alert("ì˜¬ë°”ë¥¸ íœ´ëŒ€í° ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.");
            }

            const res = await fetch('/BNK/api/verification/sms/send', {
                method: 'POST',
                headers: { 'Content-Type':'application/json' },
                body: JSON.stringify({ phoneNumber: phone })
            });

            const data = await res.json();
            if (data.ok) alert('ì¸ì¦ë²ˆí˜¸ê°€ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
            else alert(data.message || 'ì „ì†¡ ì‹¤íŒ¨');
        });

        //  ì´ë©”ì¼ ì¸ì¦ë²ˆí˜¸ ë°œì†¡
        document.getElementById('send-mail')?.addEventListener('click', async () => {
            const email = document.querySelector('input[name="member_email"]').value.trim();

            if (!/^\S+@\S+\.\S+$/.test(email)) {
                return alert("ì˜¬ë°”ë¥¸ ì´ë©”ì¼ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.");
            }

            const res = await fetch('/BNK/api/verification/email/send', {
                method: 'POST',
                headers: { 'Content-Type':'application/json' },
                body: JSON.stringify({ email })
            });

            const data = await res.json();

            if (data.send) alert("ì´ë©”ì¼ë¡œ ì¸ì¦ë²ˆí˜¸ê°€ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
            else alert("ë©”ì¼ ë°œì†¡ ì‹¤íŒ¨");
        });

        // íœ´ëŒ€í° ì¸ì¦ í™•ì¸
        document.getElementById('check-sms')?.addEventListener('click', async () => {
            const phone = document.querySelector('input[name="member_phone"]').value.replace(/\D/g, '');
            const code  = document.querySelector('input[name="sms_code"]').value.trim();

            const res = await fetch('/BNK/api/verification/sms/verify', {
                method: 'POST',
                headers: { 'Content-Type':'application/json' },
                body: JSON.stringify({ phoneNumber: phone, code: code })
            });

            const data = await res.json();

            console.log("ğŸ“Œ SMS verify response:", data);

            if (data.ok || data.matched || data.success) {
                phoneVerified = true;
                alert("íœ´ëŒ€í° ì¸ì¦ ì„±ê³µ!");
            } else {
                phoneVerified = false;
                alert(data.message || "ì¸ì¦ ì‹¤íŒ¨");
            }
        });

        // ì´ë©”ì¼ ì¸ì¦ í™•ì¸
        document.getElementById('check-mail')?.addEventListener('click', async () => {
            const code = document.querySelector('input[name="mail_code"]').value.trim();
            const email = document.querySelector('input[name="member_email"]').value.trim();

            const res = await fetch('/BNK/api/verification/email/verify', {
                method: 'POST',
                headers: { 'Content-Type':'application/json' },
                body: JSON.stringify({ email, code })
            });

            const data = await res.json();

            if (data.matched) {
                emailVerified = true;
                alert("ì´ë©”ì¼ ì¸ì¦ ì„±ê³µ!");
            } else {
                emailVerified = false;
                alert("ì´ë©”ì¼ ì¸ì¦ ì‹¤íŒ¨");
            }
        });

        // ì•„ì´ë”” ì°¾ê¸°
        document.getElementById('btn-find-id').addEventListener('click', async () => {
            const isPhone = tabPhone.classList.contains('active');

            if (isPhone) {
                /* ---- íœ´ëŒ€í° ë°©ì‹ ---- */
                if (!phoneVerified) return alert("íœ´ëŒ€í° ì¸ì¦ì„ ì™„ë£Œí•˜ì„¸ìš”.");

                const name = document.querySelector('input[name="name_phone"]').value.trim();
                const phone = document.querySelector('input[name="member_phone"]').value.replace(/\D/g, '');

                if (!name) return alert("ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.");

                const res = await fetch('/BNK/member/findid/phone', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: name,
                        phone: phone
                    })
                });

                const data = await res.json();
                if (!data.ok) return alert(data.message || "ì¼ì¹˜í•˜ëŠ” íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤.");

                openIdModal(data.mid);

            } else {
                /* ---- ì´ë©”ì¼ ë°©ì‹ ---- */
                if (!emailVerified) return alert("ì´ë©”ì¼ ì¸ì¦ì„ ì™„ë£Œí•˜ì„¸ìš”.");

                const name = document.querySelector('input[name="name_email"]').value.trim();
                const email = document.querySelector('input[name="member_email"]').value.trim();

                if (!name) return alert("ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.");

                const res = await fetch('/BNK/member/findid/email', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: name,
                        email: email
                    })
                });

                const data = await res.json();

                if (!data.ok) return alert(data.message || "ì¼ì¹˜í•˜ëŠ” íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤.");

                openIdModal(data.mid);
            }
        });
    })();
</script>

    <footer><div th:replace="~{layouts/footer.html}"></div></footer>
</body>

<style>
  main {
    width: 1200px;
    background-color: #F6F6F8;
    padding: 80px 20px;
    margin: 0 auto;
  }
  body {
    font-family: 'Noto Sans KR', 'ë§‘ì€ ê³ ë”•', sans-serif;
    background: #F6F6F8;
    color: #111827;
    line-height: 1.5;
  }
  .container { max-width: 1200px; margin: 0 auto; padding: 28px 16px 40px; }  
 
  /* ë²„íŠ¼ */
  .btns { display: flex; justify-content: center; gap: 10px; margin: 10px 0 20px; }

  a { text-decoration: none; color: inherit; }

  /* ê°ì‹¸ëŠ” */
  .form-card {
    background: #fff;
    border: 1px solid #e5e7eb;
    border-radius: 20px;
    box-shadow: 0 10px 20px rgba(2,6,23,.06);
    padding: 28px 30px;
    margin-bottom: 24px;
  }

  .field-td { text-align: center; padding: 10px; }
  .field-td input {
    width: 400px; height: 44px; border: 1px solid #e5e7eb; border-radius: 10px; box-sizing: border-box; padding: 0 12px; outline: none;
  }

  .field-row { display: flex; }
  .field-row input { width: 500px; height: 25px; border: 1px solid #bbb; padding: 10px; border-radius: 10px; }
  .field-label { font-size: 18px; } 

  /* ê²€ìƒ‰ ì•„ì´ì½˜ */
  .search-icon-wrapper { display: flex; justify-content: center; align-items: center; margin-bottom: 15px; }
  .search-icon { width: 70px; height: 70px; border-radius: 50%; background-color: #fff5f5; display: flex; justify-content: center; align-items: center; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
  .search-icon span { font-size: 32px; color: #D91A1A; }

  .phone-certify-row { display: flex; align-items: center; gap: 10px; }
  .btn-certify { width: 100px; height: 44px; font-size: 14px; flex-shrink: 0; }

  /* ë°©ì‹ ìŠ¤ìœ„ì¹˜ */
  .method-switch {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
    max-width: 520px;
    width: 100%;
    margin: 8px auto 0;
  }
  .method-btn {
    appearance: none;
    border: 1px solid #E5E7EB;
    background: #fff;
    border-radius: 12px;
    padding: 12px 14px;
    font-weight: 700;
    cursor: pointer;
    transition: box-shadow .15s, border-color .15s;
  }
  .method-btn.active {
    border: 2px solid #D6001C;
    box-shadow: 0 6px 16px rgba(214,0,28,.12);
  }  

  /* íŒ¨ë„ í† ê¸€ */
  .method-panel.hidden { display: none; }

  /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
  .id-modal { position: fixed; inset: 0; display: none; z-index: 10000; }
  .id-modal.open { display: block; }
  .id-modal-backdrop { position: absolute; inset: 0; background: rgba(0,0,0,.35); }
  .id-modal-dialog {
    position: relative; margin: 8vh auto 0; max-width: 420px;
    background: #fff; border: 1px solid #e5e7eb; border-radius: 16px;
    box-shadow: 0 20px 40px rgba(2,6,23,.25); overflow: hidden;
  }
  .id-modal-header { display: flex; justify-content: space-between; align-items: center; padding: 14px 18px; border-bottom: 1px solid #eee; }
  .id-modal-close { appearance: none; background: transparent; border: none; font-size: 20px; line-height: 1; cursor: pointer; }
  .id-modal-body { padding: 18px; color: #374151; }
  .id-modal-footer { padding: 14px 18px 20px; display: flex; justify-content: center; }

  .form-card input:focus {
      outline: none;
      border-color: #d1d5db;
      box-shadow: 0 0 0 3px rgba(214, 0, 28, .12);
  }
</style>
</html>