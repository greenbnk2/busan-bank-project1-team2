<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.co.bnkfirst.mapper.UsersMapper">
    <!-- 로그인(main) -->
    <select id="findByMid" parameterType="string" resultType="kr.co.bnkfirst.dto.UsersDTO">
        SELECT
            MID     AS mid,
            MPW     AS mpw,
            MNAME   AS mname,
            MPHONE  AS mphone,
            MEMAIL  AS memail,
            MDATE   AS mdate,
            MGRADE  AS mgrade,
            "ROLE"    AS role
        FROM USERS
        WHERE MID = #{mid}
    </select>

    <!-- 정보입력 -->
    <insert id="insertUser" parameterType="kr.co.bnkfirst.dto.UsersDTO">
        INSERT INTO USERS (
            "uId", MID, MPW, MNAME, MGENDER, MJUMIN,
            MPHONE, MCARRIER, MBIRTH, MEMAIL, MADDRESS,
            MDATE, MGRADE, MCOND,
            MNUM, MACCESS, MLIMIT,
            "ROLE"
        )
        VALUES (
                   SEQ_USERS.NEXTVAL,
                   #{mid}, #{mpw}, #{mname}, #{mgender}, #{mjumin},
                   #{mphone}, #{mcarrier}, #{mbirth, jdbcType=DATE},
                   #{memail, jdbcType=VARCHAR}, #{maddress, jdbcType=VARCHAR},
                   SYSDATE, 'Family', '활동중',
                   '1234-' || SUBSTR(LPAD(SEQ_MNUM.NEXTVAL, 8, '0'), 1, 4)
                           || '-' || SUBSTR(LPAD(SEQ_MNUM.CURRVAL, 8, '0'), 5, 4),
                   SYSDATE,
                   1000000,
                   'USER'
               )
    </insert>

    <!-- 최근접속 일자 업데이트 -->
    <update id="updateLastAccess" parameterType="string">
        UPDATE USERS
        SET MACCESS = SYSDATE
        WHERE MID = #{mid}
    </update>

    <!-- 아이디 중복확인(info) -->
    <select id="existsByMid" parameterType="string" resultType="int">
        SELECT COUNT(*)
        FROM USERS
        WHERE "MID" = #{mid}
    </select>

    <!-- 아이디 찾기(findid) : Phone & Email -->
    <select id="findIdByPhone" resultType="string">
        SELECT MID
        FROM USERS
        WHERE TRIM(MNAME) = TRIM(#{name})
          AND REPLACE(MPHONE, '-', '') = #{phone}
    </select>

    <select id="findIdByEmail" resultType="string">
        SELECT MID
        FROM USERS
        WHERE MNAME = #{name}
          AND MEMAIL = #{email}
    </select>

    <!-- 비밀번호 찾기(findpw) : Id + Phone -->
    <select id="findByMidAndPhone" parameterType="map" resultType="kr.co.bnkfirst.dto.UsersDTO">
        SELECT
            MID     AS mid,
            MPW     AS mpw,
            MNAME   AS mname,
            MPHONE  AS mphone,
            MEMAIL  AS memail,
            MDATE   AS mdate,
            MGRADE  AS mgrade
        FROM USERS
        WHERE MID = #{mid}
          AND REPLACE(MPHONE, '-', '') = #{phone}
    </select>

    <!-- 비밀번호 찾기(findpw) : Id + Email -->
    <select id="findByMidAndEmail" parameterType="map" resultType="kr.co.bnkfirst.dto.UsersDTO">
        SELECT
            MID     AS mid,
            MPW     AS mpw,
            MNAME   AS mname,
            MPHONE  AS mphone,
            MEMAIL  AS memail,
            MDATE   AS mdate,
            MGRADE  AS mgrade
        FROM USERS
        WHERE MID = #{mid}
          AND MEMAIL = #{email}
    </select>

    <!-- 비밀번호 업데이트(임시 비밀번호 발급) -->
    <update id="updatePassword" parameterType="map">
        UPDATE USERS
        SET MPW = #{mpw}
        WHERE MID = #{mid}
    </update>

    <!-- 마이페이지 비밀번호 변경 -->
    <update id="updateMypagePassword" parameterType="map">
        UPDATE USERS
        SET MPW = #{mpw}
        WHERE MID = #{mid}
    </update>

    <!-- 회원 탈퇴 -->
    <delete id="deletePcontractByMid" parameterType="string">
        DELETE FROM PCONTRACT
        WHERE UID = (
            SELECT UID FROM USERS WHERE MID = #{mid}
        )
    </delete>
    <delete id="deleteUserByMid" parameterType="string">
        DELETE FROM USERS
        WHERE MID = #{mid}
    </delete>

    <!-- 회원가입 완료 시 기본 계좌도 개설 -->
    <insert id="insertDefaultAccount" parameterType="kr.co.bnkfirst.dto.product.PcontractDTO">

        <selectKey keyProperty="pacc" resultType="string" order="BEFORE">
            SELECT '321-654-' || LPAD(PACC_SEQ.NEXTVAL, 5, '0')
            FROM DUAL
        </selectKey>

        INSERT INTO PCONTRACT (
            PCUID, PCPID, PACC, PCNAPW, PBALANCE, PNEW, PEND, "TYPE"
        ) VALUES (
            #{pcuid}, #{pcpid}, #{pacc}, #{pcnapw}, #{pbalance},
            SYSDATE,  ADD_MONTHS(SYSDATE, 24), 'COMMON'
        )
    </insert>
</mapper>