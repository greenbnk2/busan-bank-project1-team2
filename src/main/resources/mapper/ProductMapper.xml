<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.co.bnkfirst.mapper.ProductMapper">

    <select id="resultPcontract" resultType="kr.co.bnkfirst.dto.product.PcontractDTO">
        SELECT * FROM pcontract c
                          JOIN product p
                               ON c.PCPID  = p.PID
                          JOIN users u
                               ON c.PCUID = u.mid
        WHERE u.mid = #{mid} AND c.PCPID = #{pcpid}
    </select>

    <select id="selectFund" resultType="kr.co.bnkfirst.dto.product.FundDTO">
        select * from fund
    </select>

    <select id="selectFundDetail" parameterType="string" resultType="kr.co.bnkfirst.dto.product.FundDTO">
        SELECT
        FID        AS fid,
        FNAME      AS fname,
        FAMC       AS famc,
        FRLVL      AS frlvl,
        FTYPE      AS ftype,
        FREFPR     AS frefpr,
        FSETDT     AS fsetdt,
        FTC        AS ftc,
        FM1PR      AS fm1pr,
        FM3PR      AS fm3pr,
        FM6PR      AS fm6pr,
        FM12PR     AS fm12pr,
        FACMPR     AS facmpr,

        -- 모달용 추가 필드들
        BASEDT     AS basedt,
        EVALTYPE   AS evaltype,
        MGMTCOMP   AS mgmtcomp,   -- 실제 컬럼명 확인(예: MGMT_COMP 등)
        GRADE3Y    AS grade3y,
        GRADE5Y    AS grade5y,
        RELATEDFUND AS relatedfund,
        INVESTREGION AS investregion,
        PAST2023   AS past2023,
        PAST2024   AS past2024,
        FEE1Y      AS fee1y,
        FEE3Y      AS fee3y,
        STARTINFO  AS startinfo,
        SALESFEE   AS salesfee,
        FAMILYSIZE AS familysize,
        TRUSTFEE   AS trustfee,
        AUM        AS aum,
        REDEEMFEE  AS redeemfee,
        CHART1     AS chart1,
        CHART2     AS chart2

        FROM FUND  <!-- 실제 펀드 테이블명으로 변경 -->
        WHERE FID = #{fid}
    </select>

    <!-- 계좌번호 가져오기 -->
    <select id="selectAllByUidAndType" parameterType="string" resultType="kr.co.bnkfirst.dto.product.PcontractDTO">
        SELECT * FROM PCONTRACT WHERE PCUID=#{pcuid} AND "TYPE"=#{type}
    </select>

    <select id="selectByAccAndUidAndType" parameterType="string" resultType="kr.co.bnkfirst.dto.product.PcontractDTO">
        SELECT * FROM PCONTRACT WHERE PCUID=#{pcuid} AND PACC=#{pacc} AND "TYPE"=#{type}
    </select>

    <insert id="savePcontract" parameterType="kr.co.bnkfirst.dto.product.PcontractDTO">
        INSERT INTO PCONTRACT (
            pcuid,
            pcpid,
            pcnapw,
            pacc,
            pnew,
            pend,
            pbalance,
            pcwtpi,
            "TYPE")
        VALUES (
           #{pcuid},
           #{pcpid},
           #{pcnapw},
           #{pacc},
           #{pnew, jdbcType=TIMESTAMP},
           #{pend, jdbcType=TIMESTAMP},
           #{pbalance},
           #{pcwtpi},
           #{type} || '-TD')
    </insert>
    <update id="drawPcontract" parameterType="kr.co.bnkfirst.dto.product.PcontractDTO">
        UPDATE PCONTRACT SET
            pbalance = pbalance - #{pbalance}
        WHERE PACC = #{pacc}
          AND "TYPE" = #{type}
    </update>
    <update id="depositPcontract" parameterType="kr.co.bnkfirst.dto.product.PcontractDTO">
        UPDATE PCONTRACT SET
            pbalance = pbalance + #{pbalance}
        WHERE PACC = #{pacc}
          AND "TYPE" = #{type}
    </update>
    <update id="partSellPcontract" parameterType="kr.co.bnkfirst.dto.product.PcontractDTO">
        UPDATE PCONTRACT
        SET PBALANCE = PBALANCE - #{pbalance}
        WHERE PCUID = #{pcuid}
          AND PCPID = #{pcpid}
    </update>
    <delete id="fullSellPcontract" parameterType="kr.co.bnkfirst.dto.product.PcontractDTO">
        DELETE FROM PCONTRACT
        WHERE PCUID = #{pcuid}
          AND PCPID = #{pcpid}
    </delete>
    <update id="extraBuyPcontract" parameterType="kr.co.bnkfirst.dto.product.PcontractDTO">
        UPDATE PCONTRACT
        SET PBALANCE = PBALANCE + #{pbalance}
        WHERE PCUID = #{pcuid}
          AND PCPID = #{pcpid}
    </update>
</mapper>
